<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Embarques Dimpex</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #ffffff; /* White background */
            color: #333; /* Dark text for contrast on white */
            line-height: 1.6;
        }
        .container {
            max-width: 1280px;
            margin: 2rem auto;
            padding: 1.5rem;
        }
        .card {
            background-color: #fdfdfd; /* Very light card background */
            border-radius: 0.75rem; /* Rounded corners */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); /* Lighter shadow */
            padding: 1.5rem;
            transition: transform 0.2s ease-in-out;
            border: 1px solid #e2e8f0; /* Subtle border */
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #63b3ed; /* Primary blue color (unchanged) */
        }
        .kpi-label {
            font-size: 0.9rem;
            color: #666; /* Darker gray text for visibility */
            font-weight: 500;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        canvas {
            max-width: 100%;
            height: auto;
        }
        .table-header {
            background-color: #e2e8f0; /* Light gray table header */
            color: #4a5568; /* Darker text for header */
        }
        .table-row:nth-child(even) {
            background-color: #f8f9fa; /* Lighter alternating row */
        }
        .table-row:nth-child(odd) {
            background-color: #ffffff; /* White alternating row */
        }
        .table-row:hover {
            background-color: #e2e8f0; /* Hover effect */
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px; /* Pill shape */
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #fff; /* White text for badges (unchanged) */
        }
        /* Specific status colors (unchanged) */
        .status-aprovado { background-color: #48bb78; } /* Green */
        .status-em-producao { background-color: #ecc94b; } /* Yellow */
        .status-carga-pronta { background-color: #ed8936; } /* Orange */
        .status-booking { background-color: #9f7aea; } /* Purple */
        .status-atd { background-color: #4299e1; } /* Blue */
        .status-documentacao-pendente { background-color: #e53e3e; } /* Red */
        .status-documentacao-ok { background-color: #38b2ac; } /* Teal */
        .status-em-transito { background-color: #3182ce; } /* Stronger Blue */
        .status-ata { background-color: #805ad5; } /* Darker Purple */
        .status-entrega-ao-cliente { background-color: #38a169; } /* Darker Green */
        .status-reprovado { background-color: #c53030; } /* Dark Red */
        .status-aprovado-com-ressalvas { background-color: #d69e2e; } /* Dark Orange */
        .status-solicitado { background-color: #319795; } /* Dark Teal */
        .status-em-andamento { background-color: #d69e2e; } /* Dark Orange */

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333; /* Dark text for titles */
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e2e8f0; /* Lighter border */
            padding-bottom: 0.5rem;
        }
        .insights-box {
            background-color: #fdfdfd; /* Very light background for insights */
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 2rem;
            border: 1px solid #e2e8f0; /* Subtle border */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .insights-box h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #63b3ed; /* Primary blue color (unchanged) */
            margin-bottom: 1rem;
        }
        .insights-box ul {
            list-style: disc;
            margin-left: 1.25rem;
        }
        .insights-box li {
            margin-bottom: 0.5rem;
            color: #444; /* Darker text for insights list */
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="flex flex-col sm:flex-row justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-4 sm:mb-0">Dashboard de Embarques</h1>
            <div class="text-sm text-gray-600">
                Data de Referência: <span id="currentDate"></span>
            </div>
        </header>

        <!-- KPIs Section -->
        <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="card text-center">
                <div class="kpi-value" id="totalShipmentsKPI">0</div>
                <div class="kpi-label">Total de Embarques</div>
            </div>
            <div class="card text-center">
                <div class="kpi-value" id="inTransitShipmentsKPI">0</div>
                <div class="kpi-label">Em Trânsito</div>
            </div>
            <div class="card text-center">
                <div class="kpi-value" id="customsClearanceShipmentsKPI">0</div>
                <div class="kpi-label">Desembaraço Aduaneiro</div>
            </div>
            <div class="card text-center">
                <div class="kpi-value" id="deliveredShipmentsKPI">0</div>
                <div class="kpi-label">Entregues ao Cliente</div>
            </div>
        </section>

        <!-- Charts Section -->
        <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="card">
                <h2 class="section-title">Embarques por Status</h2>
                <div class="chart-container">
                    <canvas id="shipmentStatusChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2 class="section-title">Tendência de Embarques (Últimos 6 Meses)</h2>
                <div class="chart-container">
                    <canvas id="shipmentTrendChart"></canvas>
                </div>
            </div>
        </section>

        <!-- Critical Shipments Section -->
        <section class="card mb-8">
            <h2 class="section-title">Embarques Críticos / Atrasados</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-300">
                    <thead class="table-header">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Embarque</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Status Atual</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">ETA Original</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">ETA Atualizada</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Dias Atraso</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Ações</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200" id="criticalShipmentsTableBody">
                        <!-- Critical shipments will be rendered here -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Insights and Strategies Section -->
        <section class="insights-box">
            <h2 class="section-title">Insights e Estratégias</h2>
            <div id="insightsContent">
                <h3>Análise Geral:</h3>
                <ul>
                    <li>O volume total de embarques está em <span id="totalShipmentsInsight"></span>.</li>
                    <li>A maioria dos embarques está atualmente em fase de <span id="mostCommonStatusInsight"></span>, indicando um gargalo potencial ou uma fase de alta atividade.</li>
                    <li><span id="criticalShipmentsCountInsight"></span> embarques estão em status crítico ou atrasado, necessitando de atenção imediata.</li>
                </ul>

                <h3>Recomendações Estratégicas:</h3>
                <ul>
                    <li>**Otimização de Documentação:** Se "Documentação Pendente" for um status comum, revise os processos de coleta e aprovação de documentos para acelerar o fluxo.</li>
                    <li>**Monitoramento Proativo:** Para embarques em "Em Trânsito" e "Chegada no Porto de Destino (ATA)", utilize ferramentas de rastreamento em tempo real e mantenha comunicação constante com agentes de carga para antecipar problemas.</li>
                    <li>**Análise de Atrasos:** Investigue as causas raiz dos atrasos nos embarques críticos para implementar medidas corretivas e preventivas. Considere a performance de fornecedores e agentes.</li>
                    <li>**Gestão de Estoque:** Alinhe as projeções de chegada dos embarques com o planejamento de estoque para evitar rupturas ou excessos.</li>
                    <li>**Comunicação com o Cliente:** Mantenha os clientes informados sobre o status de seus embarques, especialmente em casos de atraso, para gerenciar expectativas.</li>
                </ul>
            </div>
        </section>
    </div>

    <script>
        // Sample data (replace with actual data from your backend or localStorage)
        // This data structure should ideally mimic what you have in your main application
        const dimpexOrders = [
            {
                id: 'PED-015',
                poCliente: '1127TYCH',
                fornecedor: 'Fornecedor LONCIN',
                fornecedorLoja: '01',
                cliente: 'Cliente A',
                aprovacaoDate: '2025-06-29',
                statusDimpex: 'Reserva de Espaço (Booking)',
                shipmentName: 'EMB-001-CLIA',
                toyNumber: 'TOY1250001',
                blNumber: 'BL-HKG-001',
                blDate: '2025-07-10',
                pol: 'Shanghai',
                pod: 'Santos',
                prevEmbarque: '2025-07-05',
                dtBooking: '2025-07-01',
                dtETA: '2025-08-18', // Original ETA
                dtETAUpdated: '2025-08-25', // Updated ETA (simulating delay)
                dtDesembaraco: '',
                cargoAgent: 'Agente Marítimo X',
                paymentBeforeBL: true,
                container20: '1',
                container40: '0',
                container40HQ: '0',
                containerLCL: '0',
                followUp: 'Primeira reserva de espaço confirmada. Aguardando coleta da carga.',
                incoterm: 'FOB',
                documents: [],
                productLines: [],
                inspectionReport: { status: 'Aprovado' }
            },
            {
                id: 'PED-019',
                poCliente: '8795MX',
                fornecedor: 'Fornecedor XY',
                fornecedorLoja: '02',
                cliente: 'Cliente B',
                aprovacaoDate: '2025-06-30',
                statusDimpex: 'Em Trânsito',
                shipmentName: 'EMB-002-CLIB',
                toyNumber: 'TOY1250002',
                blNumber: '',
                blDate: '',
                pol: 'Guangzhou',
                pod: 'Paranaguá',
                prevEmbarque: '2025-07-08',
                dtBooking: '2025-07-03',
                dtETA: '2025-09-05',
                dtETAUpdated: '2025-09-05', // No delay
                dtDesembaraco: '',
                cargoAgent: 'Logística Global',
                paymentBeforeBL: false,
                container20: '0',
                container40: '1',
                container40HQ: '0',
                containerLCL: '0',
                followUp: 'Coleta agendada para amanhã. Documentos iniciais recebidos.',
                incoterm: 'CIF',
                documents: [],
                productLines: [],
                inspectionReport: { status: 'Solicitado' }
            },
            {
                id: 'PED-020',
                poCliente: '0129VO',
                fornecedor: 'Fornecedor LONCIN',
                fornecedorLoja: '01',
                cliente: 'Toyama Chile',
                aprovacaoDate: '2025-06-25',
                statusDimpex: 'Entrega ao Cliente',
                shipmentName: 'EMB-003-TYCH',
                toyNumber: 'TOY1250003',
                blNumber: 'BL-HKG-002',
                blDate: '2025-07-05',
                pol: 'Ningbo',
                pod: 'Valparaíso',
                prevEmbarque: '2025-07-03',
                dtBooking: '2025-06-28',
                dtETA: '2025-08-20',
                dtETAUpdated: '2025-08-20',
                dtDesembaraco: '',
                cargoAgent: 'TransOceanic',
                paymentBeforeBL: true,
                container20: '0',
                container40: '0',
                container40HQ: '0',
                containerLCL: '1',
                followUp: 'Carga embarcada com sucesso. BL e documentos principais recebidos.',
                incoterm: 'EXW',
                documents: [],
                productLines: [],
                inspectionReport: { status: 'Aprovado' }
            },
            {
                id: 'PED-025',
                poCliente: '4040JKL',
                fornecedor: 'Fornecedor XY',
                fornecedorLoja: '02',
                cliente: 'Cliente G',
                aprovacaoDate: '2025-07-05',
                statusDimpex: 'Em Trânsito',
                shipmentName: 'EMB-004-CLIG',
                toyNumber: 'TOY1250004',
                blNumber: 'BL-HKG-003',
                blDate: '2025-07-12',
                pol: 'Shanghai',
                pod: 'Manaus',
                prevEmbarque: '2025-07-10',
                dtBooking: '2025-07-08',
                dtETA: '2025-10-20',
                dtETAUpdated: '2025-10-25', // Simulating a small delay
                dtDesembaraco: '',
                cargoAgent: 'Ocean Freight',
                paymentBeforeBL: false,
                container20: '0',
                container40: '1',
                container40HQ: '0',
                containerLCL: '0',
                followUp: 'Navio a caminho. Monitorando a ETA.',
                incoterm: 'FOB',
                documents: [],
                productLines: [],
                inspectionReport: { status: 'Aprovado com Ressalvas' }
            },
            {
                id: 'PED-026',
                poCliente: '5050MNO',
                fornecedor: 'Fornecedor LONCIN',
                fornecedorLoja: '01',
                cliente: 'Cliente H',
                aprovacaoDate: '2025-07-06',
                statusDimpex: 'Chegada no Porto de Destino (ATA)',
                shipmentName: 'EMB-005-CLIh',
                toyNumber: 'TOY1250005',
                blNumber: 'BL-HKG-004',
                blDate: '2025-07-15',
                pol: 'Ningbo',
                pod: 'Salvador',
                prevEmbarque: '2025-07-13',
                dtBooking: '2025-07-10',
                dtETA: '2025-10-25',
                dtETAUpdated: '2025-10-25',
                dtDesembaraco: '',
                cargoAgent: 'Sea Cargo',
                paymentBeforeBL: true,
                container20: '0',
                container40: '0',
                container40HQ: '0',
                containerLCL: '1',
                followUp: 'Carga chegou ao porto. Aguardando início do desembaraço.',
                incoterm: 'CFR',
                documents: [],
                productLines: [],
                inspectionReport: { status: 'Solicitado' }
            },
            {
                id: 'PED-027',
                poCliente: '6060PQR',
                fornecedor: 'Fornecedor XY',
                fornecedorLoja: '02',
                cliente: 'Cliente I',
                aprovacaoDate: '2025-07-07',
                statusDimpex: 'Chegada no Porto de Destino (ATA)',
                shipmentName: 'EMB-006-CLII',
                toyNumber: 'TOY1250006',
                blNumber: 'BL-HKG-005',
                blDate: '2025-07-18',
                pol: 'Guangzhou',
                pod: 'Fortaleza',
                prevEmbarque: '2025-07-16',
                dtBooking: '2025-07-14',
                dtETA: '2025-11-01',
                dtETAUpdated: '2025-11-01',
                dtDesembaraco: '2025-07-25',
                cargoAgent: 'Porto Forte',
                paymentBeforeBL: false,
                container20: '1',
                container40: '0',
                container40HQ: '0',
                containerLCL: '0',
                followUp: 'Documentos entregues ao despachante. Desembaraço em andamento.',
                incoterm: 'DAP',
                documents: [],
                productLines: [],
                inspectionReport: { status: 'Aprovado' }
            },
            {
                id: 'PED-028',
                poCliente: '7070STU',
                fornecedor: 'Fornecedor LONCIN',
                fornecedorLoja: '01',
                cliente: 'Cliente J',
                aprovacaoDate: '2025-07-08',
                statusDimpex: 'Chegada no Porto de Destino (ATA)',
                shipmentName: 'EMB-007-CLIJ',
                toyNumber: 'TOY1250007',
                blNumber: 'BL-HKG-006',
                blDate: '2025-07-20',
                pol: 'Foshan',
                pod: 'Goiânia',
                prevEmbarque: '2025-07-18',
                dtBooking: '2025-07-16',
                dtETA: '2025-11-05',
                dtETAUpdated: '2025-11-15', // Significant delay
                dtDesembaraco: '2025-07-28',
                cargoAgent: 'Carga Rápida',
                paymentBeforeBL: true,
                container20: '0',
                container40: '1',
                container40HQ: '0',
                containerLCL: '0',
                followUp: 'Carga liberada pela alfândega. Aguardando agendamento de transporte final.',
                incoterm: 'DDP',
                documents: [],
                productLines: [],
                inspectionReport: { status: 'Reprovado' }
            },
            {
                id: 'PED-029',
                poCliente: '8080VWX',
                fornecedor: 'Fornecedor XY',
                fornecedorLoja: '02',
                cliente: 'Cliente K',
                aprovacaoDate: '2025-07-09',
                statusDimpex: 'Entrega ao Cliente',
                shipmentName: 'EMB-008-CLIK',
                toyNumber: 'TOY1250008',
                blNumber: 'BL-HKG-007',
                blDate: '2025-07-22',
                pol: 'Shenzhen',
                pod: 'São Paulo',
                prevEmbarque: '2025-07-20',
                dtBooking: '2025-07-18',
                dtETA: '2025-11-10',
                dtETAUpdated: '2025-11-10',
                dtDesembaraco: '2025-07-30',
                cargoAgent: 'Transportadora Expressa',
                paymentBeforeBL: true,
                container20: '0',
                container40: '0',
                container40HQ: '0',
                containerLCL: '1',
                followUp: 'Carga entregue com sucesso ao cliente. Processo finalizado.',
                incoterm: 'FOB',
                documents: [],
                productLines: [],
                inspectionReport: { status: 'Aprovado' }
            }
        ];

        // Function to format date to DD/MM/YYYY
        function formatDate(dateString) {
            if (!dateString) return 'Não informado';
            const [year, month, day] = dateString.split('-');
            if (year && month && day) {
                return `${day}/${month}/${year}`;
            }
            return 'Não informado';
        }

        // Function to get the number of days between two dates
        function getDaysDifference(date1, date2) {
            if (!date1 || !date2) return 0;
            const d1 = new Date(date1);
            const d2 = new Date(date2);
            const diffTime = Math.abs(d2 - d1);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        // Render KPIs
        function renderKPIs() {
            const totalShipments = dimpexOrders.length;
            const inTransitShipments = dimpexOrders.filter(order => order.statusDimpex === 'Em Trânsito').length;
            const customsClearanceShipments = dimpexOrders.filter(order => order.statusDimpex === 'Chegada no Porto de Destino (ATA)').length;
            const deliveredShipments = dimpexOrders.filter(order => order.statusDimpex === 'Entrega ao Cliente').length;

            document.getElementById('totalShipmentsKPI').innerText = totalShipments;
            document.getElementById('inTransitShipmentsKPI').innerText = inTransitShipments;
            document.getElementById('customsClearanceShipmentsKPI').innerText = customsClearanceShipments;
            document.getElementById('deliveredShipmentsKPI').innerText = deliveredShipments;

            // Update insights
            document.getElementById('totalShipmentsInsight').innerText = totalShipments;
        }

        // Render Shipment Status Chart (Pie Chart)
        function renderShipmentStatusChart() {
            const statusCounts = {};
            dimpexOrders.forEach(order => {
                statusCounts[order.statusDimpex] = (statusCounts[order.statusDimpex] || 0) + 1;
            });

            const labels = Object.keys(statusCounts);
            const data = Object.values(statusCounts);

            const backgroundColors = [
                '#63b3ed', '#48bb78', '#ecc94b', '#ed8936', '#9f7aea', '#e53e3e',
                '#38b2ac', '#3182ce', '#805ad5', '#38a169'
            ];

            const ctx = document.getElementById('shipmentStatusChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors.slice(0, labels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#4a5568' /* Darker color for labels on white background */
                            }
                        },
                        title: {
                            display: false,
                            text: 'Embarques por Status',
                            color: '#333'
                        }
                    }
                }
            });

            // Update insights
            const mostCommonStatus = labels[data.indexOf(Math.max(...data))];
            document.getElementById('mostCommonStatusInsight').innerText = mostCommonStatus;
        }

        // Render Shipment Trend Chart (Line Chart)
        function renderShipmentTrendChart() {
            const monthlyShipments = {};
            const today = new Date();
            for (let i = 5; i >= 0; i--) { // Last 6 months
                const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const monthYear = `${d.toLocaleString('pt-BR', { month: 'short' })} ${d.getFullYear()}`;
                monthlyShipments[monthYear] = 0;
            }

            dimpexOrders.forEach(order => {
                if (order.aprovacaoDate) {
                    const orderDate = new Date(order.aprovacaoDate);
                    const monthYear = `${orderDate.toLocaleString('pt-BR', { month: 'short' })} ${orderDate.getFullYear()}`;
                    if (monthlyShipments.hasOwnProperty(monthYear)) {
                        monthlyShipments[monthYear]++;
                    }
                }
            });

            const labels = Object.keys(monthlyShipments);
            const data = Object.values(monthlyShipments);

            const ctx = document.getElementById('shipmentTrendChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Número de Embarques',
                        data: data,
                        borderColor: '#63b3ed',
                        backgroundColor: 'rgba(99, 179, 237, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#4a5568' /* Darker color for labels on white background */
                            }
                        },
                        title: {
                            display: false,
                            text: 'Tendência de Embarques',
                            color: '#333'
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: '#cbd5e0' /* Lighter grid lines */
                            },
                            ticks: {
                                color: '#4a5568' /* Darker ticks */
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#cbd5e0' /* Lighter grid lines */
                            },
                            ticks: {
                                color: '#4a5568', /* Darker ticks */
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        // Render Critical Shipments Table
        function renderCriticalShipmentsTable() {
            const tableBody = document.getElementById('criticalShipmentsTableBody');
            tableBody.innerHTML = '';
            const today = new Date();
            let criticalCount = 0;

            const criticalShipments = dimpexOrders.filter(order => {
                if (order.dtETAUpdated) {
                    const etaUpdated = new Date(order.dtETAUpdated);
                    // Consider critical if ETA is in the past and not yet delivered, or if dtETAUpdated is significantly later than dtETA
                    const isDelayed = order.dtETA && new Date(order.dtETAUpdated) > new Date(order.dtETA);
                    
                    return (etaUpdated < today && order.statusDimpex !== 'Entrega ao Cliente') || isDelayed;
                }
                return false;
            }).sort((a, b) => {
                // Sort by most delayed first
                const delayA = a.dtETAUpdated ? getDaysDifference(a.dtETA, a.dtETAUpdated) : 0;
                const delayB = b.dtETAUpdated ? getDaysDifference(b.dtETA, b.dtETAUpdated) : 0;
                return delayB - delayA;
            });

            if (criticalShipments.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 whitespace-nowrap text-center text-gray-600">Nenhum embarque crítico ou atrasado encontrado.</td></tr>`;
                document.getElementById('criticalShipmentsCountInsight').innerText = '0';
                return;
            }

            criticalShipments.forEach(order => {
                criticalCount++;
                const etaOriginal = formatDate(order.dtETA);
                const etaUpdated = formatDate(order.dtETAUpdated);
                const daysDelayed = order.dtETAUpdated ? getDaysDifference(order.dtETA, order.dtETAUpdated) : 0;

                const statusClass = order.statusDimpex.toLowerCase().replace(/ /g, '-').replace(/\//g, '-');

                const row = document.createElement('tr');
                row.className = 'table-row';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800">${order.shipmentName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        <span class="status-badge status-${statusClass}">${order.statusDimpex}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${etaOriginal}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${etaUpdated}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-bold">${daysDelayed > 0 ? daysDelayed : 0} dias</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <a href="#" class="text-indigo-600 hover:text-indigo-800">Ver Detalhes</a>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            document.getElementById('criticalShipmentsCountInsight').innerText = criticalCount;
        }

        // Initialize Dashboard
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').innerText = today.toLocaleDateString('pt-BR', options);

            renderKPIs();
            renderShipmentStatusChart();
            renderShipmentTrendChart();
            renderCriticalShipmentsTable();
        });
    </script>
</body>
</html>
