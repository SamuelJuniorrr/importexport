<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Fluig - Central Dimpex de Embarques</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --text-color: #333;
            --light-gray: #f8f9fa;
            --border-color: #dee2e6;
            --header-bg: #fff;
            --table-header-bg: #e9ecef;
            --shadow: 0 2px 4px rgba(0,0,0,0.05);
            --red-alert: #dc3545;
            --green-success: #28a745;
            --orange-warning: #ffc107;
            --blue-info: #17a2b8;
            --purple-status: #6f42c1;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            color: var(--text-color);
        }

        body {
            background-color: var(--light-gray);
            line-height: 1.6;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .header {
            background-color: var(--header-bg);
            padding: 15px 40px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        .header h1 {
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 13px;
            color: #666;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-icon {
            background-color: #e0e0e0;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: #666;
            cursor: pointer;
            flex-shrink: 0;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
            white-space: nowrap;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
            white-space: nowrap;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: var(--shadow);
            flex-grow: 1;
        }

        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex-grow: 1;
            min-width: 150px;
        }

        .filter-group label {
            font-weight: 500;
            color: #555;
            font-size: 13px;
            white-space: nowrap;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 14px;
            min-width: 120px;
        }

        .search-group {
            flex-grow: 2;
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 250px;
        }

        .search-input-wrapper {
            display: flex;
            width: 100%;
        }

        .search-group input {
            flex-grow: 1;
            border-right: none;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        .search-icon-btn {
            background-color: transparent;
            border: 1px solid var(--border-color);
            border-left: none;
            border-radius: 0 5px 5px 0;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 16px;
            color: #666;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            background-color: #fff;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table thead th {
            background-color: var(--table-header-bg);
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            color: #555;
            text-transform: uppercase;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }

        table tbody td {
            padding: 10px 15px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
            vertical-align: middle;
            white-space: nowrap;
        }

        table tbody tr:hover {
            background-color: #f5f5f5;
        }

        .pedido-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }

        .pedido-link:hover {
            text-decoration: underline;
        }

        .flag-icon {
            width: 16px;
            height: 11px;
            vertical-align: middle;
            margin-right: 5px;
            border: 1px solid #eee;
        }

        .footer-button {
            text-align: right;
            margin-top: 20px;
            padding: 10px 0;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-indicator.green { background-color: var(--green-success); }
        .status-indicator.yellow { background-color: var(--orange-warning); }
        .status-indicator.red { background-color: var(--red-alert); }
        .status-indicator.blue { background-color: var(--blue-info); }
        .status-indicator.purple { background-color: var(--purple-status); }
        .status-indicator.gray { background-color: var(--secondary-color); }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 700px; /* Increased max-width for better content display */
            position: relative;
            max-height: 90vh; /* Limit height for scrollable content */
            overflow-y: auto; /* Enable scrolling for modal content */
        }

        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            background: none;
            border: none;
            cursor: pointer;
            color: #888;
        }

        .modal-content h3 {
            margin-bottom: 20px;
            font-size: 20px;
            color: var(--primary-color);
        }

        .modal-content pre {
            background-color: var(--light-gray);
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }

        .modal-content .modal-actions {
            margin-top: 25px;
            text-align: right;
        }

        .modal-content .input-group {
            margin-bottom: 15px;
        }

        .modal-content .input-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
            font-weight: 500;
            color: #555;
        }

        .modal-content .input-group input[type="text"],
        .modal-content .input-group input[type="date"],
        .modal-content .input-group select,
        .modal-content textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s ease-in-out;
        }

        .modal-content .input-group input:focus,
        .modal-content .input-group select:focus,
        .modal-content textarea:focus {
            border-color: var(--primary-color);
        }

        /* Order Details Specific Styles */
        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 10px 20px;
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px dashed #e9ecef;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 500;
            color: #555;
            flex-basis: 40%;
            text-align: left;
        }

        .detail-value {
            font-weight: 600;
            color: #333;
            flex-basis: 60%;
            text-align: right;
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }

        .section-title {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .document-item {
            background-color: #f0f5fa;
            border: 1px solid #cce0f0;
            border-radius: 5px;
            padding: 10px 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .document-item span {
            font-weight: 500;
            color: #333;
        }

        .document-actions button {
            margin-left: 10px;
        }

        .status-tag {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .status-tag.pendente { background-color: #ffe0b2; color: #e65100; } /* Orange */
        .status-tag.aprovado { background-color: #c8e6c9; color: #2e7d32; } /* Green */
        .status-tag.rejeitado { background-color: #ffcdd2; color: #c62828; } /* Red */
        .status-tag.analise { background-color: #bbdefb; color: #1976d2; } /* Blue */
        .status-tag.nao-aplicavel { background-color: #e0e0e0; color: #616161; } /* Gray */

        .inspection-report-section {
            background-color: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .inspection-report-section h4 {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .inspection-report-section .detail-row {
            padding: 8px 0;
        }

        .inspection-report-section .detail-label {
            flex-basis: 30%;
        }

        .inspection-report-section .detail-value {
            flex-basis: 70%;
        }

        .inspection-actions {
            margin-top: 20px;
            text-align: right;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <h1>Central Dimpex de Embarques</h1>
            <p>Gerencie e acompanhe todos os embarques e documentos.</p>
        </div>
        <div class="header-right">
            <button class="btn-secondary" id="logoutButton">Sair (Logout)</button>
            <span class="header-icon" onclick="showMessage('Informa칞칫es', 'Esta 칠 a Central Dimpex de Embarques. Aqui voc칡 pode visualizar, aprovar e gerenciar documentos e relat칩rios de inspe칞칚o para cada pedido.')">?</span>
        </div>
    </header>

    <div class="container" id="main-content">
        <div class="filters">
            <div class="filter-group">
                <label for="statusFilter">Status:</label>
                <select id="statusFilter" onchange="renderOrdersTable()">
                    <option value="Todos">Todos</option>
                    <option value="Pendente">Pendente</option>
                    <option value="Aprovado">Aprovado</option>
                    <option value="Rejeitado">Rejeitado</option>
                    <option value="Em An치lise">Em An치lise</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="supplierFilter">Fornecedor:</label>
                <select id="supplierFilter" onchange="renderOrdersTable()">
                    <option value="Todos">Todos</option>
                    <option value="Fornecedor A">Fornecedor A</option>
                    <option value="Fornecedor B">Fornecedor B</option>
                    <option value="Fornecedor C">Fornecedor C</option>
                </select>
            </div>
            <div class="filter-group search-group">
                <label for="searchFilter">Buscar por N췈 Pedido ou Cliente:</label>
                <div class="search-input-wrapper">
                    <input type="text" id="searchFilter" placeholder="Buscar por N췈 Pedido ou Cliente" onkeyup="renderOrdersTable()">
                    <button class="search-icon-btn" onclick="renderOrdersTable()">游댌</button>
                </div>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>N췈 PEDIDO</th>
                        <th>ID SOLICITA칂츾O PRINCIPAL</th>
                        <th>CLIENTE</th>
                        <th>FORNECEDOR</th>
                        <th>PA칈S ORIGEM</th>
                        <th>STATUS DIMPEX</th>
                        <th>DATA 칔LTIMA ATUALIZA칂츾O</th>
                        <th>A칂칏ES</th>
                    </tr>
                </thead>
                <tbody id="ordersTableBody">
                    <!-- Orders will be rendered here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="orderDetailsModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeOrderDetailsModal()">&times;</button>
            <h3>Detalhes do Pedido <span id="modalOrderId"></span></h3>

            <div class="details-grid">
                <div class="detail-row">
                    <div class="detail-label">N췈 Pedido:</div>
                    <div class="detail-value" id="detailModalOrderId"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">ID Principal:</div>
                    <div class="detail-value" id="detailModalParentOrderId"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Cliente:</div>
                    <div class="detail-value" id="detailModalClient"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Fornecedor:</div>
                    <div class="detail-value" id="detailModalSupplier"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Pa칤s Origem:</div>
                    <div class="detail-value" id="detailModalOriginCountry"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Status Dimpex:</div>
                    <div class="detail-value" id="detailModalDimpexStatus"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Data 칔ltima Atualiza칞칚o:</div>
                    <div class="detail-value" id="detailModalLastUpdateDate"></div>
                </div>
            </div>

            <h4 class="section-title">Documentos do Pedido</h4>
            <div id="documentsList">
                <!-- Documents will be loaded here -->
            </div>

            <div class="inspection-report-section">
                <h4>Relat칩rio de Inspe칞칚o</h4>
                <div class="detail-row">
                    <div class="detail-label">Status:</div>
                    <div class="detail-value" id="inspectionStatus"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Data de Aprova칞칚o:</div>
                    <div class="detail-value" id="inspectionApprovalDate"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Aprovado Por:</div>
                    <div class="detail-value" id="inspectionApprovedBy"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Conte칰do do Relat칩rio:</div>
                    <div class="detail-value">
                        <button class="btn-secondary btn-sm" onclick="viewInspectionReportContent()">Visualizar</button>
                    </div>
                </div>
                <div class="inspection-actions">
                    <button class="btn-primary" onclick="openApproveInspectionModal()">Aprovar Relat칩rio</button>
                    <button class="btn-secondary" onclick="openRejectInspectionModal()">Rejeitar Relat칩rio</button>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeOrderDetailsModal()">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Document Viewer Modal -->
    <div id="documentViewerModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="document.getElementById('documentViewerModal').classList.remove('active');">&times;</button>
            <h3>Visualizar Documento: <span id="documentViewerTitle"></span></h3>
            <pre id="documentViewerContent"></pre>
            <div class="modal-actions">
                <button class="btn-primary" onclick="document.getElementById('documentViewerModal').classList.remove('active');">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Approve Document Modal -->
    <div id="approveDocumentModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="document.getElementById('approveDocumentModal').classList.remove('active');">&times;</button>
            <h3>Aprovar Documento</h3>
            <div class="input-group">
                <label for="approveDocumentDate">Data de Aprova칞칚o:</label>
                <input type="date" id="approveDocumentDate">
            </div>
            <div class="input-group">
                <label for="approveDocumentApprovedBy">Aprovado Por:</label>
                <input type="text" id="approveDocumentApprovedBy" value="Usu치rio Dimpex" readonly>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="document.getElementById('approveDocumentModal').classList.remove('active');">Cancelar</button>
                <button class="btn-primary" onclick="approveDocument()">Aprovar</button>
            </div>
        </div>
    </div>

    <!-- Reject Document Modal -->
    <div id="rejectDocumentModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="document.getElementById('rejectDocumentModal').classList.remove('active');">&times;</button>
            <h3>Rejeitar Documento</h3>
            <div class="input-group">
                <label for="rejectDocumentReason">Motivo da Rejei칞칚o:</label>
                <textarea id="rejectDocumentReason" rows="4" placeholder="Descreva o motivo da rejei칞칚o..."></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="document.getElementById('rejectDocumentModal').classList.remove('active');">Cancelar</button>
                <button class="btn-primary" onclick="rejectDocument()">Rejeitar</button>
            </div>
        </div>
    </div>

    <!-- Approve Inspection Report Modal -->
    <div id="approveInspectionModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="document.getElementById('approveInspectionModal').classList.remove('active');">&times;</button>
            <h3>Aprovar Relat칩rio de Inspe칞칚o</h3>
            <div class="input-group">
                <label for="approveInspectionDate">Data de Aprova칞칚o:</label>
                <input type="date" id="approveInspectionDate">
            </div>
            <div class="input-group">
                <label for="approveInspectionApprovedBy">Aprovado Por:</label>
                <input type="text" id="approveInspectionApprovedBy" value="Usu치rio Dimpex" readonly>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="document.getElementById('approveInspectionModal').classList.remove('active');">Cancelar</button>
                <button class="btn-primary" onclick="approveInspectionReport()">Aprovar</button>
            </div>
        </div>
    </div>

    <!-- Reject Inspection Report Modal -->
    <div id="rejectInspectionModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="document.getElementById('rejectInspectionModal').classList.remove('active');">&times;</button>
            <h3>Rejeitar Relat칩rio de Inspe칞칚o</h3>
            <div class="input-group">
                <label for="rejectInspectionReason">Motivo da Rejei칞칚o:</label>
                <textarea id="rejectInspectionReason" rows="4" placeholder="Descreva o motivo da rejei칞칚o..."></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="document.getElementById('rejectInspectionModal').classList.remove('active');">Cancelar</button>
                <button class="btn-primary" onclick="rejectInspectionReport()">Rejeitar</button>
            </div>
        </div>
    </div>

    <!-- Message Modal (reused for general messages) -->
    <div id="messageModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" id="messageModalCloseBtn">&times;</button>
            <h3 id="messageModalTitle"></h3>
            <div id="messageModalContent"></div>
            <div class="modal-actions">
                <button class="btn-primary" id="messageModalConfirmBtn">OK</button>
                <button class="btn-secondary" id="messageModalCancelBtn">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        let dimpexOrders = [];
        let currentViewingOrder = null;
        let currentViewingDocumentIndex = -1;

        // Initial data for Dimpex orders
        const initialDimpexOrders = [
            {
                orderId: 'PED-001', parentOrderId: 'SOL-001', client: 'TOTVS BRASIL', supplier: 'Fornecedor A', originCountry: 'Hong Kong',
                dimpexStatus: 'Pendente', lastUpdateDate: '2025-06-20',
                documents: [
                    { name: 'Packing List', status: 'Recebido', content: '--- Packing List ---\n\nConte칰do de exemplo para o Packing List.\n\nDetalhes dos itens embalados e suas quantidades.' },
                    { name: 'Commercial Invoice', status: 'Pendente', content: '', dimpexApprovalStatus: 'Pendente' },
                    { name: 'Bill of Lading', status: 'N칚o Recebido', content: '', dimpexApprovalStatus: 'N/A' }
                ],
                inspectionReport: { status: 'Pendente', reportContent: '--- Relat칩rio de Inspe칞칚o ---\n\nRelat칩rio detalhado da inspe칞칚o de qualidade dos produtos.\n\nResultados: Aprovado com pequenas ressalvas.', approvalDate: '', approvedBy: '' }
            },
            {
                orderId: 'PED-002', parentOrderId: 'SOL-009', client: 'ACME Corp', supplier: 'Fornecedor B', originCountry: 'Col칪mbia',
                dimpexStatus: 'Em An치lise', lastUpdateDate: '2025-06-21',
                documents: [
                    { name: 'Nota Fiscal', status: 'Recebido', content: '--- Nota Fiscal ---\n\nDetalhes da Nota Fiscal.\n\nValores e impostos.' },
                    { name: 'Certificado de Origem', status: 'Recebido', content: '--- Certificado de Origem ---\n\nConte칰do do Certificado de Origem.' }
                ],
                inspectionReport: { status: 'Aprovado', reportContent: '--- Relat칩rio de Inspe칞칚o ---\n\nRelat칩rio de inspe칞칚o para PED-002.\n\nStatus: Aprovado.', approvalDate: '2025-06-22', approvedBy: 'Jo칚o Silva' }
            },
            {
                orderId: 'PED-003', parentOrderId: 'SOL-002', client: 'Global Tech', supplier: 'Fornecedor A', originCountry: 'Hong Kong',
                dimpexStatus: 'Rejeitado', lastUpdateDate: '2025-06-19',
                documents: [
                    { name: 'Packing List', status: 'Recebido', content: '--- Packing List ---\n\nConte칰do de exemplo para o Packing List.\n\nDetalhes dos itens embalados e suas quantidades.' },
                    { name: 'Commercial Invoice', status: 'Rejeitado', content: '', dimpexApprovalStatus: 'Rejeitado', rejectionReason: 'Valores incorretos.' }
                ],
                inspectionReport: { status: 'Rejeitado', reportContent: '--- Relat칩rio de Inspe칞칚o ---\n\nRelat칩rio de inspe칞칚o para PED-003.\n\nStatus: Rejeitado. Motivo: Produtos danificados.', approvalDate: '2025-06-20', approvedBy: 'Maria Souza' }
            },
            {
                orderId: 'SAP-001', parentOrderId: 'SOL-018', client: 'Cliente Col칪mbia 1', originCountry: 'Col칪mbia',
                dimpexStatus: 'Pendente', lastUpdateDate: '2025-07-01',
                supplier: 'Fornecedor C',
                documents: [
                    { name: 'NF-e', status: 'Recebido', content: '--- Nota Fiscal Eletr칪nica ---\n\nConte칰do da NF-e para o pedido SAP-001.\n\nDetalhes da transa칞칚o e impostos.', dimpexApprovalStatus: 'Pendente' },
                    { name: 'Documento de Transporte', status: 'Pendente', content: '', dimpexApprovalStatus: 'Pendente' }
                ],
                inspectionReport: { status: 'N/A', reportContent: 'N/A', approvalDate: '', approvedBy: '' }
            }
        ];

        function showMessage(title, content, type = 'info', onConfirm = null, onCancel = null) {
            const modal = document.getElementById('messageModal');
            document.getElementById('messageModalTitle').innerText = title;
            document.getElementById('messageModalContent').innerHTML = content;
            const confirmBtn = document.getElementById('messageModalConfirmBtn');
            const cancelBtn = document.getElementById('messageModalCancelBtn');
            const closeBtn = document.getElementById('messageModalCloseBtn');

            confirmBtn.onclick = () => { if (onConfirm) onConfirm(); modal.classList.remove('active'); };
            cancelBtn.onclick = () => { if (onCancel) onCancel(); modal.classList.remove('active'); };
            closeBtn.onclick = () => modal.classList.remove('active');

            confirmBtn.classList.add('hidden');
            cancelBtn.classList.add('hidden');
            closeBtn.classList.remove('hidden');

            if (onConfirm || onCancel) {
                closeBtn.classList.add('hidden');
                confirmBtn.classList.remove('hidden');
                if (onCancel) {
                    cancelBtn.classList.remove('hidden');
                }
            }
            modal.classList.add('active');
        }

        function renderOrdersTable() {
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = '';

            const statusFilter = document.getElementById('statusFilter').value;
            const supplierFilter = document.getElementById('supplierFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

            const getFlagImage = (country) => {
                if (country === undefined || country === null || typeof country !== 'string') {
                    return '<span class="flag-icon">游뛀</span>';
                }
                switch(country.toLowerCase()) {
                    case 'col칪mbia':
                        return '<img src="https://e7.pngegg.com/pngimages/796/10/png-clipart-flag-of-colombia-flag-of-cambodia-colombia-flag-flag-sphere-thumbnail.png" alt="Bandeira da Col칪mbia" class="flag-icon">';
                    case 'hong kong':
                        return '<img src="https://e7.pngegg.com/pngimages/630/750/png-clipart-flag-of-china-association-of-southeast-asian-nations-national-flag-asean%E3%81%AE%E7%B4%8B%E7%AB%A0-china-orange-world-thumbnail.png" alt="Bandeira de Hong Kong" class="flag-icon">';
                    default:
                        return '<span class="flag-icon">游뛀</span>';
                }
            };

            let filteredOrders = dimpexOrders.filter(order => {
                const matchesStatus = statusFilter === 'Todos' || order.dimpexStatus === statusFilter;
                const matchesSupplier = supplierFilter === 'Todos' || order.supplier === supplierFilter;
                const matchesSearch = searchFilter === '' ||
                                      order.orderId.toLowerCase().includes(searchFilter) ||
                                      (order.parentOrderId && order.parentOrderId.toLowerCase().includes(searchFilter)) ||
                                      (order.client && order.client.toLowerCase().includes(searchFilter));
                return matchesStatus && matchesSupplier && matchesSearch;
            });

            if (filteredOrders.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 20px;">Nenhum pedido encontrado com os filtros aplicados.</td></tr>`;
                return;
            }

            filteredOrders.forEach(order => {
                const row = document.createElement('tr');
                let statusIndicatorClass = '';
                switch (order.dimpexStatus) {
                    case 'Pendente': statusIndicatorClass = 'yellow'; break;
                    case 'Aprovado': statusIndicatorClass = 'green'; break;
                    case 'Rejeitado': statusIndicatorClass = 'red'; break;
                    case 'Em An치lise': statusIndicatorClass = 'blue'; break;
                    default: statusIndicatorClass = 'gray'; break;
                }

                row.innerHTML = `
                    <td><a href="#" class="pedido-link" onclick="viewOrderDetails('${order.orderId}')">${order.orderId}</a></td>
                    <td>${order.parentOrderId || 'N/A'}</td>
                    <td>${order.client || 'N/A'}</td>
                    <td>${order.supplier || 'N/A'}</td>
                    <td>${getFlagImage(order.originCountry)} ${order.originCountry || 'N/A'}</td>
                    <td><span class="status-indicator ${statusIndicatorClass}"></span>${order.dimpexStatus}</td>
                    <td>${order.lastUpdateDate}</td>
                    <td>
                        <button class="btn-primary btn-sm" onclick="viewOrderDetails('${order.orderId}')">Ver Detalhes</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function viewOrderDetails(orderId) {
            currentViewingOrder = dimpexOrders.find(order => order.orderId === orderId);
            if (!currentViewingOrder) {
                showMessage('Erro', 'Detalhes do pedido n칚o encontrados.', 'error');
                return;
            }

            document.getElementById('modalOrderId').innerText = currentViewingOrder.orderId;
            document.getElementById('detailModalOrderId').innerText = currentViewingOrder.orderId;
            document.getElementById('detailModalParentOrderId').innerText = currentViewingOrder.parentOrderId || 'N/A';
            document.getElementById('detailModalClient').innerText = currentViewingOrder.client || 'N/A';
            document.getElementById('detailModalSupplier').innerText = currentViewingOrder.supplier || 'N/A';
            document.getElementById('detailModalOriginCountry').innerText = currentViewingOrder.originCountry || 'N/A';
            document.getElementById('detailModalDimpexStatus').innerText = currentViewingOrder.dimpexStatus;
            document.getElementById('detailModalLastUpdateDate').innerText = currentViewingOrder.lastUpdateDate;

            renderDocumentsList();
            renderInspectionReport();

            document.getElementById('orderDetailsModal').classList.add('active');
        }

        function closeOrderDetailsModal() {
            document.getElementById('orderDetailsModal').classList.remove('active');
            currentViewingOrder = null;
            currentViewingDocumentIndex = -1;
        }

        function renderDocumentsList() {
            const documentsListDiv = document.getElementById('documentsList');
            documentsListDiv.innerHTML = '';

            if (!currentViewingOrder || !currentViewingOrder.documents || currentViewingOrder.documents.length === 0) {
                documentsListDiv.innerHTML = '<p>Nenhum documento dispon칤vel para este pedido.</p>';
                return;
            }

            currentViewingOrder.documents.forEach((doc, index) => {
                let statusClass = '';
                let approvalStatusText = doc.dimpexApprovalStatus || 'N/A';
                switch (approvalStatusText) {
                    case 'Pendente': statusClass = 'pendente'; break;
                    case 'Aprovado': statusClass = 'aprovado'; break;
                    case 'Rejeitado': statusClass = 'rejeitado'; break;
                    case 'Em An치lise': statusClass = 'analise'; break;
                    default: statusClass = 'nao-aplicavel'; break;
                }

                const docItem = document.createElement('div');
                docItem.className = 'document-item';
                docItem.innerHTML = `
                    <span>${doc.name}</span>
                    <div class="document-actions">
                        ${doc.content ? `<button class="btn-secondary btn-sm" onclick="viewDocumentContent(${index})">Visualizar</button>` : ''}
                        <span class="status-tag ${statusClass}">${approvalStatusText}</span>
                        ${doc.status === 'Recebido' && doc.dimpexApprovalStatus === 'Pendente' ?
                            `<button class="btn-primary btn-sm" onclick="openApproveDocumentModal(${index})">Aprovar</button>
                             <button class="btn-secondary btn-sm" onclick="openRejectDocumentModal(${index})">Rejeitar</button>` : ''
                        }
                    </div>
                `;
                documentsListDiv.appendChild(docItem);
            });
        }

        function viewDocumentContent(index) {
            if (!currentViewingOrder || !currentViewingOrder.documents || index === undefined) return;

            const doc = currentViewingOrder.documents[index];
            if (doc && doc.content) {
                document.getElementById('documentViewerTitle').innerText = doc.name;
                document.getElementById('documentViewerContent').innerText = doc.content;
                document.getElementById('documentViewerModal').classList.add('active');
            } else {
                showMessage('Informa칞칚o', 'Conte칰do do documento n칚o dispon칤vel.', 'info');
            }
        }

        function openApproveDocumentModal(index) {
            currentViewingDocumentIndex = index;
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('approveDocumentDate').value = today;
            document.getElementById('approveDocumentModal').classList.add('active');
        }

        function approveDocument() {
            if (currentViewingDocumentIndex === -1 || !currentViewingOrder) return;

            const doc = currentViewingOrder.documents[currentViewingDocumentIndex];
            const approvalDate = document.getElementById('approveDocumentDate').value;
            const approvedBy = document.getElementById('approveDocumentApprovedBy').value;

            doc.dimpexApprovalStatus = 'Aprovado';
            doc.approvalDate = approvalDate;
            doc.approvedBy = approvedBy;
            currentViewingOrder.lastUpdateDate = new Date().toISOString().slice(0, 10);

            updateDimpexOrderStatus(); // Check if overall status needs update
            saveDimpexOrders();
            renderDocumentsList();
            document.getElementById('approveDocumentModal').classList.remove('active');
            showMessage('Sucesso', `Documento "${doc.name}" aprovado com sucesso!`, 'success');
        }

        function openRejectDocumentModal(index) {
            currentViewingDocumentIndex = index;
            document.getElementById('rejectDocumentReason').value = '';
            document.getElementById('rejectDocumentModal').classList.add('active');
        }

        function rejectDocument() {
            if (currentViewingDocumentIndex === -1 || !currentViewingOrder) return;

            const doc = currentViewingOrder.documents[currentViewingDocumentIndex];
            const rejectionReason = document.getElementById('rejectDocumentReason').value.trim();

            if (!rejectionReason) {
                showMessage('Aten칞칚o', 'Por favor, forne칞a um motivo para a rejei칞칚o.', 'warning');
                return;
            }

            doc.dimpexApprovalStatus = 'Rejeitado';
            doc.rejectionReason = rejectionReason;
            currentViewingOrder.lastUpdateDate = new Date().toISOString().slice(0, 10);

            updateDimpexOrderStatus(); // Check if overall status needs update
            saveDimpexOrders();
            renderDocumentsList();
            document.getElementById('rejectDocumentModal').classList.remove('active');
            showMessage('Sucesso', `Documento "${doc.name}" rejeitado com sucesso.`, 'success');
        }

        function renderInspectionReport() {
            if (!currentViewingOrder || !currentViewingOrder.inspectionReport) return;

            const report = currentViewingOrder.inspectionReport;
            document.getElementById('inspectionStatus').innerHTML = `<span class="status-tag ${report.status.toLowerCase().replace(/\s/g, '-') || 'nao-aplicavel'}">${report.status || 'N/A'}</span>`;
            document.getElementById('inspectionApprovalDate').innerText = report.approvalDate || 'N/A';
            document.getElementById('inspectionApprovedBy').innerText = report.approvedBy || 'N/A';

            const approveBtn = document.querySelector('#orderDetailsModal .inspection-actions .btn-primary');
            const rejectBtn = document.querySelector('#orderDetailsModal .inspection-actions .btn-secondary');

            if (report.status === 'Pendente') {
                approveBtn.style.display = 'inline-block';
                rejectBtn.style.display = 'inline-block';
            } else {
                approveBtn.style.display = 'none';
                rejectBtn.style.display = 'none';
            }
        }

        function viewInspectionReportContent() {
            if (!currentViewingOrder || !currentViewingOrder.inspectionReport) return;

            const report = currentViewingOrder.inspectionReport;
            if (report.reportContent && report.reportContent !== 'N/A') {
                document.getElementById('documentViewerTitle').innerText = 'Relat칩rio de Inspe칞칚o';
                document.getElementById('documentViewerContent').innerText = report.reportContent;
                document.getElementById('documentViewerModal').classList.add('active');
            } else {
                showMessage('Informa칞칚o', 'Conte칰do do relat칩rio de inspe칞칚o n칚o dispon칤vel.', 'info');
            }
        }

        function openApproveInspectionModal() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('approveInspectionDate').value = today;
            document.getElementById('approveInspectionModal').classList.add('active');
        }

        function approveInspectionReport() {
            if (!currentViewingOrder) return;

            const report = currentViewingOrder.inspectionReport;
            const approvalDate = document.getElementById('approveInspectionDate').value;
            const approvedBy = document.getElementById('approveInspectionApprovedBy').value;

            report.status = 'Aprovado';
            report.approvalDate = approvalDate;
            report.approvedBy = approvedBy;
            currentViewingOrder.lastUpdateDate = new Date().toISOString().slice(0, 10);

            updateDimpexOrderStatus();
            saveDimpexOrders();
            renderInspectionReport();
            document.getElementById('approveInspectionModal').classList.remove('active');
            showMessage('Sucesso', 'Relat칩rio de inspe칞칚o aprovado com sucesso!', 'success');
        }

        function openRejectInspectionModal() {
            document.getElementById('rejectInspectionReason').value = '';
            document.getElementById('rejectInspectionModal').classList.add('active');
        }

        function rejectInspectionReport() {
            if (!currentViewingOrder) return;

            const report = currentViewingOrder.inspectionReport;
            const rejectionReason = document.getElementById('rejectInspectionReason').value.trim();

            if (!rejectionReason) {
                showMessage('Aten칞칚o', 'Por favor, forne칞a um motivo para a rejei칞칚o.', 'warning');
                return;
            }

            report.status = 'Rejeitado';
            report.rejectionReason = rejectionReason;
            currentViewingOrder.lastUpdateDate = new Date().toISOString().slice(0, 10);

            updateDimpexOrderStatus();
            saveDimpexOrders();
            renderInspectionReport();
            document.getElementById('rejectInspectionModal').classList.remove('active');
            showMessage('Sucesso', 'Relat칩rio de inspe칞칚o rejeitado com sucesso!', 'success');
        }

        function updateDimpexOrderStatus() {
            if (!currentViewingOrder) return;

            const allDocsApproved = currentViewingOrder.documents.every(doc => doc.dimpexApprovalStatus === 'Aprovado' || doc.dimpexApprovalStatus === 'N/A' || doc.status === 'N칚o Recebido');
            const anyDocRejected = currentViewingOrder.documents.some(doc => doc.dimpexApprovalStatus === 'Rejeitado');
            const inspectionApproved = currentViewingOrder.inspectionReport.status === 'Aprovado';
            const inspectionRejected = currentViewingOrder.inspectionReport.status === 'Rejeitado';
            const inspectionNA = currentViewingOrder.inspectionReport.status === 'N/A';

            if (anyDocRejected || inspectionRejected) {
                currentViewingOrder.dimpexStatus = 'Rejeitado';
            } else if (allDocsApproved && (inspectionApproved || inspectionNA)) {
                currentViewingOrder.dimpexStatus = 'Aprovado';
            } else if (currentViewingOrder.documents.some(doc => doc.dimpexApprovalStatus === 'Pendente') || currentViewingOrder.inspectionReport.status === 'Pendente') {
                currentViewingOrder.dimpexStatus = 'Em An치lise';
            } else {
                currentViewingOrder.dimpexStatus = 'Pendente'; // Default if none of the above
            }
            renderOrdersTable(); // Re-render main table to reflect status change
        }

        function saveDimpexOrders() {
            localStorage.setItem('dimpexOrders', JSON.stringify(dimpexOrders));
        }

        function loadDimpexOrders() {
            const storedOrders = localStorage.getItem('dimpexOrders');
            if (storedOrders) {
                dimpexOrders = JSON.parse(storedOrders);
                // Ensure all new fields are present in loaded data for consistency
                dimpexOrders.forEach(order => {
                    if (order.dimpexStatus === undefined) {
                        order.dimpexStatus = 'Pendente';
                    }
                    if (order.lastUpdateDate === undefined) {
                        order.lastUpdateDate = new Date().toISOString().slice(0, 10);
                    }
                    if (order.client === undefined) {
                        order.client = 'N/A';
                    }
                    if (order.supplier === undefined) {
                        order.supplier = 'N/A';
                    }
                    if (order.originCountry === undefined) {
                        order.originCountry = 'N/A';
                    }
                    if (order.documents === undefined) {
                        order.documents = [];
                    }
                    if (order.inspectionReport === undefined) {
                        order.inspectionReport = {};
                    }
                    if (order.inspectionReport.status === undefined) {
                        order.inspectionReport.status = 'N/A';
                    }
                    if (order.inspectionReport.reportContent === undefined) {
                        order.inspectionReport.reportContent = '';
                    }
                    if (order.inspectionReport.approvalDate === undefined) {
                        order.inspectionReport.approvalDate = '';
                    }
                    if (order.inspectionReport.approvedBy === undefined) {
                        order.inspectionReport.approvedBy = '';
                    }

                    order.documents.forEach(doc => {
                        if (doc.dimpexApprovalStatus === undefined) {
                            doc.dimpexApprovalStatus = doc.status === 'Recebido' ? 'Pendente' : 'N/A';
                        }
                        if (doc.status === 'Recebido' && !doc.content) {
                            doc.content = `--- Documento ${doc.name} ---\n\nConte칰do de exemplo para o documento ${doc.name}.\n\nEste 칠 um placeholder para visualiza칞칚o.`;
                        }
                    });
                });
            } else {
                dimpexOrders = initialDimpexOrders;
                localStorage.setItem('dimpexOrders', JSON.stringify(initialDimpexOrders));
            }
        }

        function logout() {
            // Redirects the user back to the main index.html (login page)
            // This is done by changing the parent window's location if dimpex.html is in an iframe,
            // or the current window's location if it's opened directly.
            if (window.parent && window.parent.location !== window.location) {
                window.parent.location.href = 'index.html';
            } else {
                window.location.href = 'index.html';
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadDimpexOrders();
            renderOrdersTable();

            // Add event listener for the new logout button
            const logoutButton = document.getElementById('logoutButton');
            if (logoutButton) {
                logoutButton.addEventListener('click', logout);
            }
        });
    </script>
</body>
</html>
